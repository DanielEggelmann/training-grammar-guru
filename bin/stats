#!/bin/bash

# An ad hoc file that gives some (maybe) imporant descriptive statistics.

CORPUS='./data/javascript-sources.sqlite3'


query-corpus() {
    local query
    query="$1"
    if [ ! -f "$CORPUS" ]; then
        echo "Corpus not found: $CORPUS" 2>&1
        exit -1
    fi
    echo "> $query"

    sqlite3 -header -csv "$CORPUS" "$query"
}

minified_files() {
    local query
    read -r -d '' query <<'SQL'
    SELECT COUNT(*) as `minified.files`
      FROM source_file
     WHERE path GLOB '*.min.js';
SQL
    query-corpus "$query"
}

usable_files() {
    local query
    read -r -d '' query <<'SQL'
    SELECT COUNT(*) as `usable.files`
      FROM usable_source
SQL
    query-corpus "$query"
}

sum_folds() {
    local query
    read -r -d '' query <<'SQL'
        SELECT fold, SUM(n_tokens)
          FROM vectorized_source JOIN fold_assignment USING (hash)
         GROUP BY fold;
SQL
    echo "> $query"
    sqlite3 javascript.sqlite3 "$query"
}

avg_folds() {
    local query
    read -r -d '' query <<SQL
        SELECT AVG(tokens) FROM (
            SELECT SUM(n_tokens) tokens
              FROM vectorized_source JOIN fold_assignment USING (hash)
             GROUP BY fold
        );
SQL

    echo "> $query"
    sqlite3 javascript.sqlite3 "$query"
}

minified_files
# 14354

usable_files
# 479998


#sum_folds
# 0|10148370
# 1|11757743
# 2|10929836
# 3|10283616
# 4|10783852
# 5|14807363
# 6|10253839
# 7|10026583
# 8|11170749
# 9|10446591

#avg_folds
# 11060854.2
