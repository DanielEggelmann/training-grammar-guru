#!/usr/bin/env python3

"""
Converts all the source files in the corpus to compact vectors.
"""

import sys

from tqdm import tqdm

from sensibility import Corpus, Vectors
from sensibility.tokenize_js import tokenize


def convert_to_vectors(corpus: 'Corpus', vectors: Vectors) -> None:
    """
    Convert every usable source in the corpus to a vector.
    Does NOT create fold assignments.
    """
    for file_hash in tqdm(corpus):
        source_file = corpus.get_source(file_hash)
        try:
            tokens = tokenize(source_file.decode('UTF-8'))
        except Exception as err:
            print("Error:", file_hash, repr(err), file=sys.stderr)
            continue
        vectors.insert(file_hash, tokens)


if __name__ == '__main__':
    # Vectorizes the corpus.

    try:
        _, source, destination = sys.argv
    except ValueError:
        print("Usage:  python", sys.argv[0], "sources.sqlite3 "
              "vectors.sqlite3")
        exit(-1)

    corpus = Corpus.connect_to(source)
    vectors = Vectors.connect_to(destination)
    convert_to_vectors(corpus, vectors)
